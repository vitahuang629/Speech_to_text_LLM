<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>è¨ºæ‰€èªéŸ³è¾¨è­˜</title>
  <style>
    body { 
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    margin: 0;
    padding: 0;
    background-image: url('static/postcard.jpeg');
    background-size: cover;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-position: center;
    font-family: sans-serif;
  }

    .button-container {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
  }
    button {
    padding: 1rem 2rem;
    font-size: 1.2rem;
    margin: 1rem;
  }
    h1 {
      text-align: center;
  }
    #transcript { 
      margin-top: 2rem; 
      font-size: 1.5rem; 
      white-space: pre-wrap;
      display: none; /* éš±è—å³æ™‚è¾¨è­˜æ–‡å­— */
  }
    #summaryResult { 
    margin-top: 2rem;
    font-size: 1.5rem;
    white-space: pre-wrap;
    display: none;
    background-color: transparent;
    border: none;
    color: #222;
    max-width: 90%;
    max-width: 800px;
    text-align: center;
  }
    .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0,0,0,.3);
    border-radius: 50%;
    border-top-color: #000;
    animation: spin 1s ease-in-out infinite;
  }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* éŸ³è¨Šå‹•ç•«æ¨£å¼ */
    #audioAnimation {
      margin-top: 2rem;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      display: none;
    }
    .audio-bar {
      display: inline-block;
      width: 8px;
      height: 30px;
      margin: 0 4px;
      background-color: #4CAF50;
      border-radius: 4px;
      animation: audio-wave 1.2s ease-in-out infinite;
    }
    .audio-bar:nth-child(2) { animation-delay: 0.1s; }
    .audio-bar:nth-child(3) { animation-delay: 0.2s; }
    .audio-bar:nth-child(4) { animation-delay: 0.3s; }
    .audio-bar:nth-child(5) { animation-delay: 0.4s; }
    
    @keyframes audio-wave {
      0%, 100% { height: 30px; }
      50% { height: 60px; }
    }
    
    .status-text {
      margin-top: 1rem;
      font-size: 1.2rem;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>ğŸ™ï¸ å³æ™‚èªéŸ³è¾¨è­˜ </h1>
  <button id="startBtn">é–‹å§‹è¾¨è­˜</button>
  <button id="stopBtn" disabled>åœæ­¢è¾¨è­˜</button>
  
  <!-- éŸ³è¨Šå‹•ç•« -->
  <div id="audioAnimation">
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
    <div class="audio-bar"></div>
  </div>
  <div id="statusText" class="status-text">æº–å‚™å°±ç·’ï¼Œè«‹é»æ“Šã€Œé–‹å§‹è¾¨è­˜ã€</div>
  
  <!-- éš±è—çš„å³æ™‚è¾¨è­˜æ–‡å­—å€åŸŸ -->
  <div id="transcript">è¾¨è­˜æ–‡å­—å°‡é¡¯ç¤ºåœ¨æ­¤...</div>
  
  <!-- åªä¿ç•™æ‘˜è¦çµæœå€åŸŸ -->
  <div id="summaryResult"></div>
  <button id="copyBtn" style="display: none;">ğŸ“‹ è¤‡è£½æ‘˜è¦</button>

  <script>
    let websocket;
    let audioContext;
    let processor;
    let input;
    let stream;
    let sessionId = null; // å„²å­˜æœƒè©±ID

    const transcriptDiv = document.getElementById("transcript");
    const summaryResultDiv = document.getElementById("summaryResult");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const audioAnimation = document.getElementById("audioAnimation");
    const statusText = document.getElementById("statusText");

    const copyBtn = document.getElementById("copyBtn");

    copyBtn.onclick = () => {
      const summaryText = summaryResultDiv.innerText.replace(/^ğŸ“‹ LLMæ‘˜è¦ï¼š\n/, "");
      navigator.clipboard.writeText(summaryText).then(() => {
        copyBtn.innerText = "âœ… å·²è¤‡è£½ï¼";
        setTimeout(() => copyBtn.innerText = "ğŸ“‹ è¤‡è£½æ‘˜è¦", 1500);
      }).catch(err => {
        console.error("è¤‡è£½å¤±æ•—ï¼š", err);
        copyBtn.innerText = "âŒ è¤‡è£½å¤±æ•—";
      });
    };

    startBtn.onclick = async () => {
      startBtn.disabled = true;
      stopBtn.disabled = false;
      transcriptDiv.innerText = ""; // æ¸…ç©ºè¾¨è­˜æ–‡å­—
      summaryResultDiv.style.display = "none";
      
      // é¡¯ç¤ºéŸ³è¨Šå‹•ç•«
      audioAnimation.style.display = "flex";
      statusText.innerText = "æ­£åœ¨éŒ„éŸ³ä¸¦è¾¨è­˜...";
      
      sessionId = null; // é‡ç½®æœƒè©±ID

      try {
        stream = await navigator.mediaDevices.getUserMedia({ audio: true });
      } catch (err) {
        statusText.innerText = "âŒ ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼Œè«‹ç¢ºèªç€è¦½å™¨è¨­å®šåŠæ¬Šé™";
        startBtn.disabled = false;
        stopBtn.disabled = true;
        audioAnimation.style.display = "none";
        return;
      }

      // é€™è£¡ç”¨ ws:// æˆ– wss:// çœ‹ä½ çš„ç¶²ç«™æ˜¯ http é‚„æ˜¯ https
      const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
      websocket = new WebSocket(wsProtocol + window.location.host + "/ws/asr");
      // é€™è£¡æ”¹æˆå›ºå®šé€£åˆ° FastAPI çš„ port 8000
      // const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
      // websocket = new WebSocket(wsProtocol + "localhost:8000" + "/ws/asr");

      websocket.onopen = () => {
        statusText.innerText = "éº¥å…‹é¢¨å·²å•Ÿå‹•ï¼Œæ­£åœ¨è¾¨è­˜ä¸­...";
        audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });

        input = audioContext.createMediaStreamSource(stream);
        processor = audioContext.createScriptProcessor(4096, 1, 1);

        processor.onaudioprocess = (e) => {
          const inputData = e.inputBuffer.getChannelData(0);
          const pcm = convertFloat32ToInt16(inputData);
          if (websocket.readyState === WebSocket.OPEN) {
            websocket.send(pcm);
          }
        };

        input.connect(processor);
        processor.connect(audioContext.destination);
      };

      websocket.onmessage = (event) => {
        try {
          // å˜—è©¦è§£æJSONæ ¼å¼
          const data = JSON.parse(event.data);
          if (data.type === "session_id") {
            // å„²å­˜æœƒè©±ID
            sessionId = data.session_id;
            console.log("æ”¶åˆ°æœƒè©±ID:", sessionId);
          }
        } catch (e) {
          // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œå‰‡ç‚ºä¸€èˆ¬è¾¨è­˜çµæœ
          const text = event.data;
          transcriptDiv.innerText += "\n" + text;
          // ä¸é¡¯ç¤ºå³æ™‚è¾¨è­˜æ–‡å­—ï¼Œä½†ä»ç„¶è¨˜éŒ„
        }
      };

      websocket.onerror = (event) => {
        statusText.innerText = "WebSocket é€£ç·šéŒ¯èª¤";
        console.error("WebSocket error:", event);
      };

      websocket.onclose = () => {
        statusText.innerText = "WebSocket å·²é—œé–‰";
      };
    };

    // stopBtn.onclick = async () => {
    //   startBtn.disabled = false;
    //   stopBtn.disabled = true;

    //   // éš±è—éŸ³è¨Šå‹•ç•«
    //   audioAnimation.style.display = "none";
    //   statusText.innerText = "è¾¨è­˜å·²åœæ­¢ï¼Œæ­£åœ¨ç”Ÿæˆæ‘˜è¦...";

    //   if (processor) processor.disconnect();
    //   if (input) input.disconnect();
    //   if (audioContext) audioContext.close();
      
    //   // é—œé–‰ä¸»è¦çš„èªéŸ³è¾¨è­˜ WebSocket
    //   if (websocket) websocket.close();
    //   if (stream) stream.getTracks().forEach(track => track.stop());

    //   // å¦‚æœæœ‰æœƒè©±IDï¼Œä½¿ç”¨REST APIå–å¾—æœ€çµ‚è¾¨è­˜çµæœ
    //   if (sessionId) {
    //     try {
    //       // é¡¯ç¤ºç­‰å¾…ä¸­çš„æç¤º
    //       summaryResultDiv.innerHTML = "ğŸ“‹ å°è©±æ‘˜è¦ï¼š<div class='loading'></div>";
    //       summaryResultDiv.style.display = "block";
          
    //       // ç­‰å¾…ä¸€å°æ®µæ™‚é–“ï¼Œç¢ºä¿å¾Œç«¯å·²è™•ç†å®Œç•¢
    //       setTimeout(async () => {
    //         try {
    //           const response = await fetch(`/api/final-result/${sessionId}`);
    //           //const response = await fetch("http://localhost:8000/api/final-result/" + sessionId);
    //           const data = await response.json();
    //           print(data.type)
              
    //           if (data.type === "final_result") {
    //             // ä¸é¡¯ç¤ºæœ€çµ‚è¾¨è­˜çµæœï¼Œåªé¡¯ç¤ºLLMæ‘˜è¦
                
    //             // é¡¯ç¤ºLLMæ‘˜è¦
    //             if (data.summary && data.summary !== "æ­£åœ¨ç”Ÿæˆæ‘˜è¦...") {
    //               summaryResultDiv.innerHTML = "ğŸ“‹ LLMæ‘˜è¦ï¼š\n" + data.summary;
    //               statusText.innerText = "æ‘˜è¦å·²ç”Ÿæˆå®Œæˆ";
    //               copyBtn.style.display = "inline-block";
    //             } else {
    //               summaryResultDiv.innerHTML = "ğŸ“‹ LLMæ‘˜è¦ï¼š\næ­£åœ¨ç”Ÿæˆæ‘˜è¦...";
    //               statusText.innerText = "æ­£åœ¨ç”Ÿæˆæ‘˜è¦...";
                  
    //               // å¦‚æœæ‘˜è¦é‚„æ²’æº–å‚™å¥½ï¼Œå®šæœŸæª¢æŸ¥
    //               let checkCount = 0;
    //               const checkSummary = async () => {
    //                 if (checkCount >= 10) { // æœ€å¤šæª¢æŸ¥10æ¬¡
    //                   summaryResultDiv.innerHTML = "ğŸ“‹ LLMæ‘˜è¦ï¼š\næ‘˜è¦ç”Ÿæˆè¶…æ™‚ï¼Œè«‹ç¨å¾Œå†è©¦";
    //                   statusText.innerText = "æ‘˜è¦ç”Ÿæˆè¶…æ™‚";
    //                   return;
    //                 }
                    
    //                 try {
    //                   const summaryResponse = await fetch(`/api/final-result/${sessionId}`);
    //                   const summaryData = await summaryResponse.json();
                      
    //                   if (summaryData.type === "final_result" && summaryData.summary && summaryData.summary !== "æ­£åœ¨ç”Ÿæˆæ‘˜è¦...") {
    //                     summaryResultDiv.innerHTML = "ğŸ“‹ LLMæ‘˜è¦ï¼š\n" + summaryData.summary;
    //                     statusText.innerText = "æ‘˜è¦å·²ç”Ÿæˆå®Œæˆ";
    //                   } else {
    //                     checkCount++;
    //                     statusText.innerText = `æ­£åœ¨ç”Ÿæˆæ‘˜è¦...ï¼ˆ${checkCount}/10ï¼‰`;
    //                     setTimeout(checkSummary, 1000); // æ¯ç§’æª¢æŸ¥ä¸€æ¬¡
    //                   }
    //                 } catch (e) {
    //                   console.error("æª¢æŸ¥æ‘˜è¦æ™‚å‡ºéŒ¯:", e);
    //                   summaryResultDiv.innerHTML = "ğŸ“‹ LLMæ‘˜è¦ï¼š\nç²å–æ‘˜è¦æ™‚å‡ºéŒ¯";
    //                   statusText.innerText = "ç²å–æ‘˜è¦æ™‚å‡ºéŒ¯";
    //                 }
    //               };
                  
    //               setTimeout(checkSummary, 2000); // 2ç§’å¾Œé–‹å§‹æª¢æŸ¥
    //             }
    //           } else if (data.type === "pending") {
    //             // çµæœé‚„æ²’å¥½ï¼Œç¹¼çºŒè¼ªè©¢
    //             checkCount++;
    //             statusText.innerText = `æ­£åœ¨ç”Ÿæˆæ‘˜è¦...ï¼ˆ${checkCount}/10ï¼‰`;
    //             setTimeout(checkSummary, 1000);                        //7/3
    //           } else if (data.type === "error") {
    //             console.error("å–å¾—æœ€çµ‚çµæœæ™‚å‡ºéŒ¯:", data.message);
    //             summaryResultDiv.innerHTML = "1âŒ å–å¾—æ‘˜è¦æ™‚å‡ºéŒ¯";
    //             statusText.innerText = "å–å¾—æ‘˜è¦æ™‚å‡ºéŒ¯";
    //           }
    //         } catch (e) {
    //           console.error("å–å¾—æœ€çµ‚çµæœæ™‚å‡ºéŒ¯:", e);
    //           summaryResultDiv.innerHTML = "2âŒ å–å¾—æ‘˜è¦æ™‚å‡ºéŒ¯";
    //           statusText.innerText = "å–å¾—æ‘˜è¦æ™‚å‡ºéŒ¯";
    //         }
    //       }, 1000); // ç­‰å¾…1ç§’
    //     } catch (e) {
    //       console.error("å–å¾—æœ€çµ‚çµæœæ™‚å‡ºéŒ¯:", e);
    //       summaryResultDiv.innerHTML = "3âŒ å–å¾—æ‘˜è¦æ™‚å‡ºéŒ¯";
    //       statusText.innerText = "å–å¾—æ‘˜è¦æ™‚å‡ºéŒ¯";
    //     }
    //   }
    // };

        // ==================== è¤‡è£½ä¸¦æ›¿æ›é€™å€‹å®Œæ•´çš„å‡½æ•¸ ====================
    stopBtn.onclick = async () => {
      startBtn.disabled = false;
      stopBtn.disabled = true;

      // éš±è—éŸ³è¨Šå‹•ç•«
      audioAnimation.style.display = "none";
      statusText.innerText = "è¾¨è­˜å·²åœæ­¢ï¼Œæ­£åœ¨ç”Ÿæˆæ‘˜è¦...";

      // æ¸…ç†è³‡æº
      if (processor) processor.disconnect();
      if (input) input.disconnect();
      if (audioContext) audioContext.close();
      if (stream) stream.getTracks().forEach(track => track.stop());
      
      // é—œé–‰ WebSocket é€£ç·š
      if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.close();
      }

      // å¦‚æœæ²’æœ‰ session IDï¼Œå°±ç„¡æ³•æŸ¥è©¢çµæœï¼Œç›´æ¥çµæŸ
      if (!sessionId) {
        statusText.innerText = "éŒ¯èª¤ï¼šæœªå–å¾—æœ‰æ•ˆçš„æœƒè©± ID";
        return;
      }

      // --- é–‹å§‹åŸ·è¡Œæ–°çš„è¼ªè©¢é‚è¼¯ ---
      getFinalResultWithPolling(sessionId);
    };

    /**
     * å¸¶æœ‰è¼ªè©¢æ©Ÿåˆ¶çš„å‡½æ•¸ï¼Œå°ˆé–€ç”¨ä¾†ç²å–æœ€çµ‚çµæœã€‚
     * @param {string} sessionId - è¦æŸ¥è©¢çš„æœƒè©± IDã€‚
     */
    async function getFinalResultWithPolling(sessionId) {
      const maxRetries = 15; // æœ€å¤šé‡è©¦ 15 æ¬¡
      const retryInterval = 2000; // æ¯æ¬¡é‡è©¦é–“éš” 2 ç§’

      summaryResultDiv.innerHTML = "ğŸ“‹ æ­£åœ¨ç”Ÿæˆæ‘˜è¦... <div class='loading'></div>";
      summaryResultDiv.style.display = "block";
      copyBtn.style.display = "none";

      for (let i = 0; i < maxRetries; i++) {
        try {
          const response = await fetch(`/api/final-result/${sessionId}`);
          //7/9
          if (response.status === 404) {
            console.warn(`âŒ å¾Œç«¯å›æ‡‰ 404ï¼Œä»£è¡¨çµæœä¸å­˜åœ¨æˆ–å·²è¢«æ¸…ç†ï¼Œåœæ­¢è¼ªè©¢`);
            statusText.innerText = `æ‰¾ä¸åˆ°çµæœï¼Œè«‹é‡æ–°è¾¨è­˜`;
            summaryResultDiv.innerHTML = "âŒ æ‰¾ä¸åˆ°çµæœï¼Œå¯èƒ½å·²éæœŸæˆ–ä¸å­˜åœ¨";
            copyBtn.style.display = "none";
            return; // âœ… åœæ­¢è¼ªè©¢ï¼
          }

          if (!response.ok) {
            // è™•ç† HTTP éŒ¯èª¤ï¼Œä¾‹å¦‚ 500 Internal Server Error
            throw new Error(`ä¼ºæœå™¨å›æ‡‰éŒ¯èª¤ï¼Œç‹€æ…‹ç¢¼: ${response.status}`);
          }

          const data = await response.json();

          // æ ¹æ“šå¾Œç«¯å›å‚³çš„ type é€²è¡Œåˆ¤æ–· //é€™æ®µåŸå…ˆæ˜¯stringçš„æ™‚å€™
          // if (data.type === "final_result") {
          //   console.log("âœ… æˆåŠŸå–å¾—æœ€çµ‚çµæœ:", data);
            
          //   // å°‡æ‘˜è¦ä¸­çš„æ›è¡Œç¬¦ \n æ›¿æ›ç‚º HTML çš„ <br> æ¨™ç±¤ä»¥ä¾¿æ­£ç¢ºé¡¯ç¤º
          //   const formattedSummary = data.summary.replace(/\n/g, '<br>');
          //   summaryResultDiv.innerHTML = "ğŸ“‹ LLMæ‘˜è¦ï¼š<br>" + formattedSummary;
            
          //   statusText.innerText = "æ‘˜è¦å·²ç”Ÿæˆå®Œæˆ";
          //   copyBtn.style.display = "inline-block"; // é¡¯ç¤ºè¤‡è£½æŒ‰éˆ•
          //   return; // æˆåŠŸï¼ŒçµæŸè¼ªè©¢
          // }

          if (data.type === "final_result") {
            console.log("âœ… æˆåŠŸå–å¾—æœ€çµ‚çµæœ:", data);

            // å¦‚æœ summary æ˜¯ objectï¼Œå°±å…ˆæ ¼å¼åŒ–æˆæ¼‚äº®çš„æ–‡å­—
            let formattedSummary = "";
            if (typeof data.summary === "object") {
              for (const [key, value] of Object.entries(data.summary)) {
                formattedSummary += `ã€${key}ã€‘: ${value}<br>`;
              }
            } else {
              // fallback å¦‚æœæ˜¯ string
              formattedSummary = data.summary.replace(/\n/g, '<br>');
            }

            summaryResultDiv.innerHTML = "ğŸ“‹ LLMæ‘˜è¦ï¼š<br>" + formattedSummary;
            statusText.innerText = "æ‘˜è¦å·²ç”Ÿæˆå®Œæˆ";
            copyBtn.style.display = "inline-block"; // é¡¯ç¤ºè¤‡è£½æŒ‰éˆ•
            return; // æˆåŠŸï¼ŒçµæŸè¼ªè©¢
          }
          
          // å¦‚æœ type æ˜¯ "pending" æˆ– "error"ï¼Œæˆ‘å€‘éƒ½è¦–ç‚ºéœ€è¦é‡è©¦
          // å› ç‚º "error" å¾ˆå¯èƒ½åªæ˜¯å¾Œç«¯é‚„æ²’ä¾†å¾—åŠå¯«å…¥è³‡æ–™
          console.log(`â³ çµæœå°šæœªå°±ç·’ (é¡å‹: ${data.type})ï¼Œå°‡åœ¨ ${retryInterval / 1000} ç§’å¾Œé‡è©¦...`);
          statusText.innerText = `æ‘˜è¦ç”Ÿæˆä¸­... (å˜—è©¦ ${i + 1}/${maxRetries})`;

        } catch (error) {
          // è™•ç†ç¶²è·¯éŒ¯èª¤æˆ– JSON è§£æéŒ¯èª¤
          console.error(`ç²å–çµæœæ™‚ç™¼ç”ŸéŒ¯èª¤ (ç¬¬ ${i + 1} æ¬¡å˜—è©¦):`, error);
          statusText.innerText = `ç¶²è·¯æˆ–é€£ç·šéŒ¯èª¤ï¼Œæ­£åœ¨é‡è©¦... (å˜—è©¦ ${i + 1}/${maxRetries})`;
        }

        // ç­‰å¾…æŒ‡å®šæ™‚é–“å¾Œå†é€²è¡Œä¸‹ä¸€æ¬¡è¿´åœˆ
        await new Promise(resolve => setTimeout(resolve, retryInterval));
      }

      // å¦‚æœè¿´åœˆè·‘å®Œé‚„æ²’æ‹¿åˆ°çµæœï¼Œå°±é¡¯ç¤ºè¶…æ™‚éŒ¯èª¤
      console.error("âŒ è¶…éæœ€å¤§é‡è©¦æ¬¡æ•¸ï¼Œç„¡æ³•å–å¾—æ‘˜è¦ã€‚");
      summaryResultDiv.innerHTML = "âŒ å–å¾—æ‘˜è¦æ™‚å‡ºéŒ¯ (è¶…æ™‚)";
      statusText.innerText = "å–å¾—æ‘˜è¦å¤±æ•—";
      copyBtn.style.display = "none";
    }
    // =================================================================

    function convertFloat32ToInt16(buffer) {
      const l = buffer.length;
      const result = new Int16Array(l);
      for (let i = 0; i < l; i++) {
        const s = Math.max(-1, Math.min(1, buffer[i]));
        result[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
      }
      return result.buffer;
    }
  </script>
</body>
</html>
