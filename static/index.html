<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>è¨ºæ‰€èªéŸ³è¾¨è­˜</title>
  <style>
    body { 
    display: flex;
    flex-direction: column;
    align-items: center;
    height: 100%;
    margin: 0;
    padding: 0;
    background-image: url('static/postcard.jpeg');
    background-size: cover;
    background-repeat: no-repeat;
    background-attachment: fixed;
    background-position: center;
    font-family: sans-serif;
  }

    .button-container {
      display: flex;
      justify-content: center;
      margin-top: 1rem;
  }
    button {
    padding: 1rem 2rem;
    font-size: 1.2rem;
    margin: 1rem;
  }
    h1 {
      text-align: center;
  }
    #transcript { 
      margin-top: 2rem; 
      font-size: 1.5rem; 
      white-space: pre-wrap;
      display: none; /* éš±è—å³æ™‚è¾¨è­˜æ–‡å­— */
  }
    #summaryResult { 
    margin-top: 2rem;
    font-size: 1.5rem;
    white-space: pre-wrap;
    display: none;
    background-color: transparent;
    border: none;
    color: #222;
    max-width: 90%;
    max-width: 800px;
    text-align: center;
  }
    .loading {
    display: inline-block;
    width: 20px;
    height: 20px;
    border: 3px solid rgba(0,0,0,.3);
    border-radius: 50%;
    border-top-color: #000;
    animation: spin 1s ease-in-out infinite;
  }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* éŸ³è¨Šå‹•ç•«æ¨£å¼ */
    #audioAnimation {
      margin-top: 2rem;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      display: none;
    }
    .audio-bar {
      display: inline-block;
      width: 8px;
      height: 30px;
      margin: 0 4px;
      background-color: #4CAF50;
      border-radius: 4px;
      animation: audio-wave 1.2s ease-in-out infinite;
    }
    .audio-bar:nth-child(2) { animation-delay: 0.1s; }
    .audio-bar:nth-child(3) { animation-delay: 0.2s; }
    .audio-bar:nth-child(4) { animation-delay: 0.3s; }
    .audio-bar:nth-child(5) { animation-delay: 0.4s; }
    
    @keyframes audio-wave {
      0%, 100% { height: 30px; }
      50% { height: 60px; }
    }
    
    .status-text {
      margin-top: 1rem;
      font-size: 1.2rem;
      color: #666;
      text-align: center;
    }
  </style>
</head>
<body>
    <h1>ğŸ™ï¸ å³æ™‚èªéŸ³è¾¨è­˜ </h1>
    <div style="margin-bottom: 1rem; font-size: 1.2rem;">
        <input type="radio" id="roleConsultant" name = "role" value = "consultant" checked>
        <label for="roleConsultant">è«®è©¢å¸«</label>
        <input type="radio" id = "roleDoctor" name = "role" value = "doctor">
        <label for="roleDoctor">é†«å¸«</label>
    </div>
    <div id="connectionTarget" class="status-text" style="color: blue;">é€£ç·šç›®æ¨™: /ws/consultant</div>
    <div class="button-container">
        <button id="startBtn">é–‹å§‹è¾¨è­˜</button>
        <button id="stopBtn" disabled>åœæ­¢è¾¨è­˜</button>
    </div>

        <div id="audioAnimation"></div>
        <div class="audio-bar"></div>
        <div class="audio-bar"></div>
        <div class="audio-bar"></div>
        <div class="audio-bar"></div>
        <div class="audio-bar"></div>
</div>
<div id="statusText" class="status-text">æº–å‚™å°±ç·’ï¼Œè«‹é»æ“Šã€Œé–‹å§‹è¾¨è­˜ã€</div>

<div id="transcript">è¾¨è­˜æ–‡å­—å°‡é¡¯ç¤ºåœ¨æ­¤...</div>

<div id="summaryResult"></div>
<button id="copyBtn" style="display: none;">ğŸ“‹ è¤‡è£½æ‘˜è¦</button>"

</body>

<script>
    let websocket;
    let audioContext;
    let processor;
    let input;
    let stream;
    let sessionId = null; // å„²å­˜æœƒè©±ID

    const transcriptDiv = document.getElementById("transcript");
    const summaryResultDiv = document.getElementById("summaryResult");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const audioAnimation = document.getElementById("audioAnimation");
    const statusText = document.getElementById("statusText");

    const copyBtn = document.getElementById("copyBtn");

    // ====== è§’è‰²ç›¸é—œçš„ DOM å…ƒç´  ======
    const roleConsultant = document.getElementById("roleConsultant");
    const roleDoctor = document.getElementById("roleDoctor");
    const connectionTargetDiv = document.getElementById("connectionTarget");
    // ===================================
    
    // ç›£è½è§’è‰²è®Šæ›´ï¼Œä¸¦æ›´æ–°é€£ç·šç›®æ¨™é¡¯ç¤º
    const updateConnectionTarget = () => {
        const selectedRole = document.querySelector('input[name="role"]:checked').value;
        // ç¢ºä¿é€£ç·šç›®æ¨™é¡¯ç¤ºæ­£ç¢º
        const wsEndpoint = selectedRole === "consultant" ? "/ws/consultant" : "/ws/doctor"; 
        connectionTargetDiv.innerText = `é€£ç·šç›®æ¨™: ${wsEndpoint}`;
    };

    roleConsultant.onchange = updateConnectionTarget;
    roleDoctor.onchange = updateConnectionTarget;
    
    // åˆå§‹è¼‰å…¥æ™‚è¨­å®šä¸€æ¬¡
    updateConnectionTarget();

    copyBtn.onclick = () => {
        // è¤‡è£½é‚è¼¯ä¿æŒä¸è®Š
        const summaryText = summaryResultDiv.innerText.replace(/^ğŸ“‹ LLMæ‘˜è¦ï¼š\n/, "");
        navigator.clipboard.writeText(summaryText).then(() => {
            copyBtn.innerText = "âœ… å·²è¤‡è£½ï¼";
            setTimeout(() => copyBtn.innerText = "ğŸ“‹ è¤‡è£½æ‘˜è¦", 1500);
        }).catch(err => {
            console.error("è¤‡è£½å¤±æ•—ï¼š", err);
            copyBtn.innerText = "âŒ è¤‡è£½å¤±æ•—";
        });
    };

    startBtn.onclick = async () => {
        startBtn.disabled = true;
        stopBtn.disabled = false;
        transcriptDiv.innerText = ""; // æ¸…ç©ºè¾¨è­˜æ–‡å­—
        summaryResultDiv.style.display = "none";
        copyBtn.style.display = "none";

        // é¡¯ç¤ºéŸ³è¨Šå‹•ç•«
        audioAnimation.style.display = "flex";
        statusText.innerText = "æ­£åœ¨éŒ„éŸ³ä¸¦è¾¨è­˜...";
        
        sessionId = null; // é‡ç½®æœƒè©±ID
        
        // 1. æ ¹æ“šé¸å®šçš„è§’è‰²æ±ºå®š WebSocket URL
        const selectedRole = document.querySelector('input[name="role"]:checked').value;
        const wsEndpoint = selectedRole === "consultant" ? "/ws/consultant" : "/ws/doctor";

        try {
            stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        } catch (err) {
            statusText.innerText = "âŒ ç„¡æ³•å–å¾—éº¥å…‹é¢¨æ¬Šé™ï¼Œè«‹ç¢ºèªç€è¦½å™¨è¨­å®šåŠæ¬Šé™";
            startBtn.disabled = false;
            stopBtn.disabled = true;
            audioAnimation.style.display = "none";
            return;
        }

        const wsProtocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        websocket = new WebSocket(wsProtocol + window.location.host + wsEndpoint);

        websocket.onopen = () => {
            statusText.innerText = "éº¥å…‹é¢¨å·²å•Ÿå‹•ï¼Œæ­£åœ¨è¾¨è­˜ä¸­...";
            audioContext = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 16000 });

            input = audioContext.createMediaStreamSource(stream);
            // ... processor è¨­å®šä¿æŒä¸è®Š ...
            processor = audioContext.createScriptProcessor(4096, 1, 1);

            processor.onaudioprocess = (e) => {
                const inputData = e.inputBuffer.getChannelData(0);
                const pcm = convertFloat32ToInt16(inputData);
                if (websocket.readyState === WebSocket.OPEN) {
                    websocket.send(pcm);
                }
            };

            input.connect(processor);
            processor.connect(audioContext.destination);
        };

        websocket.onmessage = (event) => {
            try {
                // å˜—è©¦è§£æJSONæ ¼å¼
                const data = JSON.parse(event.data);
                
                if (data.type === "session_id") {
                    // å„²å­˜æœƒè©±ID
                    sessionId = data.session_id;
                    console.log("æ”¶åˆ°æœƒè©±ID:", sessionId);
                } 
                // VVVVVV 2. æ–°å¢æœ€çµ‚æ‘˜è¦è™•ç†é‚è¼¯ (WebSocket æ¨é€) VVVVVV
                else if (data.type === "final_summary") {
                    console.log("âœ… æ”¶åˆ°æœ€çµ‚æ‘˜è¦æ¨é€:", data);
                    
                    let formattedSummary = "";
                    if (typeof data.summary === "object") {
                        // è™•ç†ç‰©ä»¶æ ¼å¼çš„æ‘˜è¦
                        for (const [key, value] of Object.entries(data.summary)) {
                            formattedSummary += `ã€${key}ã€‘: ${value}<br>`;
                        }
                    } else if (typeof data.summary === "string") {
                        // è™•ç†å­—ä¸²æ ¼å¼çš„æ‘˜è¦
                        formattedSummary = data.summary.replace(/\n/g, '<br>');
                    }
                    
                    summaryResultDiv.innerHTML = "ğŸ“‹ LLMæ‘˜è¦ï¼š<br>" + formattedSummary;
                    statusText.innerText = "æ‘˜è¦å·²ç”Ÿæˆå®Œæˆ (WebSocket æ¨é€)";
                    copyBtn.style.display = "inline-block"; // é¡¯ç¤ºè¤‡è£½æŒ‰éˆ•
                }
                // ^^^^^^ çµæŸæ–°å¢ ^^^^^^
                
            } catch (e) {
                // å¦‚æœä¸æ˜¯JSONæ ¼å¼ï¼Œå‰‡ç‚ºä¸€èˆ¬è¾¨è­˜çµæœ (é€å­—ç¨¿)
                const text = event.data;
                // transcriptDiv.innerText += "\n" + text; // å¦‚æœè¦é¡¯ç¤ºå³æ™‚é€å­—ç¨¿ï¼Œå°±æ‰“é–‹é€™è¡Œ
                // ä¸é¡¯ç¤ºå³æ™‚è¾¨è­˜æ–‡å­—ï¼Œä½†ä»ç„¶è¨˜éŒ„
            }
        };

        websocket.onerror = (event) => {
            statusText.innerText = "WebSocket é€£ç·šéŒ¯èª¤";
            console.error("WebSocket error:", event);
        };

        websocket.onclose = () => {
            // é€£ç·šé—œé–‰ï¼Œç­‰å¾… final_summary æ¨é€å®Œæˆ
            if (statusText.innerText !== "æ‘˜è¦å·²ç”Ÿæˆå®Œæˆ (WebSocket æ¨é€)") {
                 statusText.innerText = "WebSocket å·²é—œé–‰ï¼Œç­‰å¾…æ‘˜è¦çµæœ...";
            }
        };
    };

    stopBtn.onclick = async () => {
        if (websocket && websocket.readyState === WebSocket.OPEN){
            console.log("å„ªå…ˆåŸ·è¡Œ websocket.close()");
            websocket.close()
        }else{
            console.log("websocket ç‹€æ…‹ç•°å¸¸, ç„¡æ³•ç™¼é€é—œé–‰ä¿¡è™Ÿ")
        }

        startBtn.disabled = false;
        stopBtn.disabled = true;

        // éš±è—éŸ³è¨Šå‹•ç•«
        audioAnimation.style.display = "none";
        
        // è¨­ç½®ç‹€æ…‹ç‚ºç­‰å¾…æ‘˜è¦
        statusText.innerText = "è¾¨è­˜å·²åœæ­¢ï¼Œ**ç­‰å¾…å¾Œç«¯æ‘˜è¦æ¨é€...**"; 
        summaryResultDiv.innerHTML = "ğŸ“‹ æ­£åœ¨ç”Ÿæˆæ‘˜è¦... <div class='loading'></div>";
        summaryResultDiv.style.display = "block";
        copyBtn.style.display = "none";

        // æ¸…ç†è³‡æº
        if (processor) processor.disconnect();
        if (input) input.disconnect();
        if (audioContext) audioContext.close();
        if (stream) stream.getTracks().forEach(track => track.stop());
        
    }; // <---- ä¿®æ­£é» 2: é€™è£¡ç¼ºå°‘äº† } é–‰åˆ stopBtn.onclick å‡½æ•¸ (æ‚¨æä¾›çš„ç¨‹å¼ç¢¼æ˜¯åœ¨ convertFloat32ToInt16 ä¹‹å‰)


    function convertFloat32ToInt16(buffer) {
        const l = buffer.length;
        const result = new Int16Array(l);
        for (let i = 0; i < l; i++) {
            const s = Math.max(-1, Math.min(1, buffer[i]));
            result[i] = s < 0 ? s * 0x8000 : s * 0x7FFF;
        }
        return result.buffer;
    }
</script>